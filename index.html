<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Growsports LMS</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  body { font-family: 'Inter', sans-serif; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
window.onload = function() {
const { useState, useEffect, createContext, useContext } = React;

// Firebase setup
const firebaseConfig = {
  apiKey: "AIzaSyBys0t-G2_CcgOWcx564aILnrHr4c4kII4",
  authDomain: "lmsgs-3553d.firebaseapp.com",
  projectId: "lmsgs-3553d",
  storageBucket: "lmsgs-3553d.appspot.com",
  messagingSenderId: "257801632795",
  appId: "1:257801632795:web:a6fa6e1eaa537ebfc4ccbe"
};
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const appId = 'default-app-id';

// Context
const AuthContext = createContext(null);

// Modal Component
const Modal = ({ message, onConfirm, onCancel, type }) => {
  if (!message) return null;
  return (
    <div className="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50 p-4">
      <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm text-center">
        <p className="text-lg font-semibold mb-6 text-gray-800">{message}</p>
        <div className="flex justify-center space-x-4">
          {type==='confirm' && <button onClick={onCancel} className="px-5 py-2 bg-gray-300 rounded-lg">Cancel</button>}
          <button onClick={onConfirm} className="px-5 py-2 bg-green-600 text-white rounded-lg">OK</button>
        </div>
      </div>
    </div>
  );
};

// AuthForm for login/signup
const AuthForm = ({ type }) => {
  const { setCurrentUser } = useContext(AuthContext);
  const [email,setEmail]=useState(''); const [password,setPassword]=useState('');
  const [error,setError]=useState(''); const [modal,setModal]=useState({message:'',type:''});

  const handleSubmit = async e=>{
    e.preventDefault(); setError('');
    try {
      if(type==='login'){
        await auth.signInWithEmailAndPassword(email,password);
      } else {
        const userCredential = await auth.createUserWithEmailAndPassword(email,password);
        const user = userCredential.user;
        await db.doc(`/artifacts/${appId}/users/${user.uid}/user_profile/profile`).set({
          email:user.email, role:'student', createdAt:new Date().toISOString()
        });
        setModal({message:'Sign up successful! You can now log in.', type:'alert'});
        setEmail(''); setPassword('');
      }
    } catch(err){ setError(err.message); }
  };

  const handleModalConfirm=()=>{ setModal({message:'',type:''}); if(modal.message.includes('Sign up')) setCurrentUser({role:'login'}); };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100">
      <Modal {...modal} onConfirm={handleModalConfirm} onCancel={()=>setModal({message:'',type:''})}/>
      <div className="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl">
        <h2 className="text-3xl font-extrabold text-center mb-6">{type==='login'?'Login':'Sign Up'}</h2>
        <form onSubmit={handleSubmit} className="space-y-6">
          <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full px-5 py-3 border rounded-lg"/>
          <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Password" className="w-full px-5 py-3 border rounded-lg"/>
          {error && <p className="text-red-500 text-center">{error}</p>}
          <button type="submit" className="w-full py-3 bg-green-600 text-white rounded-lg">{type==='login'?'Sign In':'Create Account'}</button>
        </form>
        <p className="mt-6 text-center text-gray-600">
          {type==='login'?"Don't have an account?":"Already have an account?"} <a href="#" onClick={()=>setCurrentUser({role:type==='login'?'signup':'login'})} className="text-green-600">{type==='login'?'Sign Up':'Log In'}</a>
        </p>
      </div>
    </div>
  );
};

// Admin Content Modal
const AdminContentModal = ({ type, onSave, onClose }) => {
  const [title,setTitle]=useState(''); const [url,setUrl]=useState('');
  const handleSave=()=>{ if(title && url){ onSave({type,title,url}); } };
  return (
    <div className="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50 p-4">
      <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
        <h3 className="text-2xl font-bold mb-4 text-gray-800 capitalize">Add New {type}</h3>
        <input placeholder={`${type} Title`} value={title} onChange={e=>setTitle(e.target.value)} className="w-full px-4 py-3 mb-4 border rounded-lg"/>
        <input placeholder={`${type} URL`} type="url" value={url} onChange={e=>setUrl(e.target.value)} className="w-full px-4 py-3 mb-4 border rounded-lg"/>
        <div className="flex justify-end space-x-4 mt-6">
          <button onClick={onClose} className="px-5 py-2 bg-gray-300 rounded-lg">Cancel</button>
          <button onClick={handleSave} className="px-5 py-2 bg-green-600 text-white rounded-lg">Save</button>
        </div>
      </div>
    </div>
  );
};

// Add Module Modal
const AddModuleModal = ({ onSave,onClose }) => {
  const [title,setTitle]=useState('');
  return (
    <div className="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50 p-4">
      <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
        <h3 className="text-2xl font-bold mb-4 text-gray-800">Add New Module</h3>
        <input placeholder="Module Title" value={title} onChange={e=>setTitle(e.target.value)} className="w-full px-4 py-3 mb-4 border rounded-lg"/>
        <div className="flex justify-end space-x-4 mt-6">
          <button onClick={onClose} className="px-5 py-2 bg-gray-300 rounded-lg">Cancel</button>
          <button onClick={()=>onSave(title)} className="px-5 py-2 bg-green-600 text-white rounded-lg">Save</button>
        </div>
      </div>
    </div>
  );
};

// Admin Panel
const AdminPanel = ({ userId }) => {
  const { setCurrentUser } = useContext(AuthContext);
  const [courses,setCourses]=useState([]); const [modal,setModal]=useState({message:'',type:''});
  const [addContentModal,setAddContentModal]=useState(null); const [isAddingModule,setIsAddingModule]=useState(null);
  const [newCourse,setNewCourse]=useState({title:'',description:'',modules:[]}); const [isAddingCourse,setIsAddingCourse]=useState(false);

  useEffect(()=>{
    const unsubscribe = db.collection(`/artifacts/${appId}/public/data/courses`).onSnapshot(snapshot=>{
      const data = snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
      setCourses(data);
    });
    return ()=>unsubscribe();
  },[]);

  const addCourse = async ()=>{
    if(!newCourse.title) return;
    await db.collection(`/artifacts/${appId}/public/data/courses`).add(newCourse);
    setNewCourse({title:'',description:'',modules:[]}); setIsAddingCourse(false);
  };

  const deleteCourse = (courseId)=>{
    setModal({
      message:'Are you sure you want to delete this course?',
      type:'confirm',
      onConfirm: async ()=>{
        setModal({message:'',type:''});
        await db.doc(`/artifacts/${appId}/public/data/courses/${courseId}`).delete();
      },
      onCancel: ()=>setModal({message:'',type:''})
    });
  };

  const handleAddModule = (courseId)=>{ setIsAddingModule({courseId}); };
  const handleSaveModule = async (title)=>{
    if(title && isAddingModule?.courseId){
      const courseRef = db.doc(`/artifacts/${appId}/public/data/courses/${isAddingModule.courseId}`);
      const docSnap = await courseRef.get();
      const modules = docSnap.data()?.modules || [];
      await courseRef.update({modules:[...modules,{title,content:[],type:'module'}]});
    }
    setIsAddingModule(null);
  };

  const handleSaveContent = async (content)=>{
    const {courseId,moduleIndex} = addContentModal;
    const courseRef = db.doc(`/artifacts/${appId}/public/data/courses/${courseId}`);
    const docSnap = await courseRef.get();
    const courseData = docSnap.data();
    courseData.modules[moduleIndex].content.push(content);
    await courseRef.update({modules:courseData.modules});
    setAddContentModal(null);
  };

  const handleLogout=async()=>{ await auth.signOut(); setCurrentUser(null); };

  const addContentToModule = (courseId,moduleIndex,type)=>{
    setAddContentModal({courseId,moduleIndex,type});
  };

  return (
    <div className="min-h-screen bg-gray-50 p-6 font-sans">
      <Modal {...modal} onConfirm={modal?.onConfirm} onCancel={modal?.onCancel}/>
      {addContentModal && <AdminContentModal type={addContentModal.type} onSave={handleSaveContent} onClose={()=>setAddContentModal(null)}/>}
      {isAddingModule && <AddModuleModal onSave={handleSaveModule} onClose={()=>setIsAddingModule(null)}/>}

      <div className="flex justify-between items-center mb-8">
        <h1 className="text-4xl font-extrabold text-green-700">Admin Dashboard</h1>
        <button onClick={handleLogout} className="px-4 py-2 bg-red-500 text-white rounded-lg">Logout</button>
      </div>

      <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <div className="flex justify-end mb-4">
          <button onClick={()=>setIsAddingCourse(!isAddingCourse)} className="px-6 py-2 bg-teal-500 text-white rounded-lg">{isAddingCourse?'Cancel':'Add New Course'}</button>
        </div>
        {isAddingCourse && (
          <div className="mb-8 p-6 bg-gray-100 rounded-lg">
            <input placeholder="Course Title" value={newCourse.title} onChange={e=>setNewCourse({...newCourse,title:e.target.value})} className="w-full px-4 py-3 mb-4 border rounded-lg"/>
            <textarea placeholder="Course Description" value={newCourse.description} onChange={e=>setNewCourse({...newCourse,description:e.target.value})} className="w-full px-4 py-3 mb-4 border rounded-lg"></textarea>
            <button onClick={addCourse} className="w-full py-3 bg-green-600 text-white rounded-lg">Create Course</button>
          </div>
        )}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {courses.map(course=>(
            <div key={course.id} className="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm">
              <h3 className="text-xl font-semibold mb-2">{course.title}</h3>
              <p className="text-gray-600 mb-4">{course.description}</p>
              <div className="flex space-x-2 mb-2">
                <button onClick={()=>deleteCourse(course.id)} className="px-4 py-2 bg-red-500 text-white text-sm rounded-lg">Delete</button>
                <button onClick={()=>handleAddModule(course.id)} className="px-4 py-2 bg-blue-500 text-white text-sm rounded-lg">Add Module</button>
              </div>
              <ul className="space-y-2">
                {course.modules?.map((mod,index)=>(
                  <li key={index} className="bg-white p-4 rounded-lg border border-gray-200">
                    <h4 className="font-bold">{mod.title}</h4>
                    <div className="flex flex-wrap gap-2 mt-2">
                      {['video','notes','quiz','assignment'].map(type=>(
                        <button key={type} onClick={()=>addContentToModule(course.id,index,type)} className="px-3 py-1 bg-cyan-500 text-white text-xs rounded-lg capitalize">{type}</button>
                      ))}
                    </div>
                    <ul className="mt-2 space-y-1 text-sm text-gray-600">
                      {mod.content?.map((c,cIndex)=>(
                        <li key={cIndex}><span className="font-semibold capitalize">{c.type}:</span> {c.title}</li>
                      ))}
                    </ul>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// Student Dashboard
const StudentDashboard = ({ userId }) => {
  const { setCurrentUser } = useContext(AuthContext);
  const [courses,setCourses]=useState([]); const [userProfile,setUserProfile]=useState({}); const [activeCourse,setActiveCourse]=useState(null); const [progress,setProgress]=useState({});

  useEffect(()=>{
    const profileRef = db.doc(`/artifacts/${appId}/users/${userId}/user_profile/profile`);
    const unsubscribeProfile = profileRef.onSnapshot(docSnap=>{
      if(docSnap.exists){ const data=docSnap.data(); setUserProfile(data); setProgress(data.progress || {}); }
    });

    const unsubscribeCourses = db.collection(`/artifacts/${appId}/public/data/courses`).onSnapshot(snapshot=>{
      const data = snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
      setCourses(data);
    });

    return ()=>{ unsubscribeProfile(); unsubscribeCourses(); };
  },[userId]);

  const toggleModule = async (courseId,index)=>{
    const key = `${courseId}-${index}`; const newProgress = {...progress,[key]:!progress[key]};
    setProgress(newProgress);
    const profileRef = db.doc(`/artifacts/${appId}/users/${userId}/user_profile/profile`);
    await profileRef.update({progress:newProgress});
  };

  const handleLogout=async()=>{ await auth.signOut(); setCurrentUser(null); };

  return (
    <div className="min-h-screen bg-gray-50 p-6 font-sans">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-4xl font-extrabold text-green-700">Student Dashboard</h1>
        <button onClick={handleLogout} className="px-4 py-2 bg-red-500 text-white rounded-lg">Logout</button>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {courses.map(course=>(
          <div key={course.id} className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
            <h3 className="text-xl font-semibold mb-2">{course.title}</h3>
            <p className="text-gray-600 mb-4">{course.description}</p>
            <ul className="space-y-2">
              {course.modules?.map((mod,index)=>(
                <li key={index} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <div className="flex justify-between items-center cursor-pointer" onClick={()=>toggleModule(course.id,index)}>
                    <span className="font-semibold">{mod.title}</span>
                    <span>{progress[`${course.id}-${index}`]?'✅':'⬜'}</span>
                  </div>
                  {progress[`${course.id}-${index}`] && (
                    <ul className="mt-2 space-y-1 text-sm text-gray-600">
                      {mod.content?.map((c,cIndex)=>(<li key={cIndex}><span className="font-semibold capitalize">{c.type}:</span> {c.title}</li>))}
                    </ul>
                  )}
                </li>
              ))}
            </ul>
          </div>
        ))}
      </div>
    </div>
  );
};

// Main App
const App = () => {
  const [currentUser,setCurrentUser] = useState(null);
  const [loading,setLoading] = useState(true);

  useEffect(()=>{
    const unsubscribe = auth.onAuthStateChanged(async user=>{
      if(user){
        const profileRef = db.doc(`/artifacts/${appId}/users/${user.uid}/user_profile/profile`);
        const docSnap = await profileRef.get();
        if(docSnap.exists) setCurrentUser({ ...user, ...docSnap.data() });
        else { await profileRef.set({email:user.email,role:'student',createdAt:new Date().toISOString()}); setCurrentUser({ ...user, role:'student', email:user.email}); }
      } else { setCurrentUser({role:'login'}); }
      setLoading(false);
    });
    return ()=>unsubscribe();
  },[]);

  if(loading) return <div className="flex items-center justify-center min-h-screen">Loading...</div>;
  if(!currentUser || currentUser.role==='login' || currentUser.role==='signup') return <AuthForm type={currentUser.role}/>;
  if(currentUser.email==='admin@lms.com') return <AdminPanel userId={currentUser.uid}/>;
  return <StudentDashboard userId={currentUser.uid}/>;
};

ReactDOM.createRoot(document.getElementById('root')).render(
  <AuthContext.Provider value={{currentUser:setCurrentUser,setCurrentUser}}>
    <App />
  </AuthContext.Provider>
);
};
</script>
</body>
</html>
